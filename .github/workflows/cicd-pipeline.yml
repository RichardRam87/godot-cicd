name: cicd-pipeline

on:
    workflow_dispatch:

permissions:
    checks: write
    contents: read

jobs:
  test:
    name: 🧪Run Tests
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4
          name: 🧾 Checkout

        - uses: MikeSchulze/gdUnit4-action@v1.1.5
          name: 🔬 Execute Tests
          with:
            godot-version: '4.3'
            paths: 'res://tests/'
            timeout: 5
            report-name: test_report.xml 

  build:
    # needs: test - commented for now for faster test iteration
    name: 🛠️ git Build Game
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows]
        type: [debug]
    steps:
        - uses: actions/checkout@v4
          name: 🧾 Checkout
          
        - uses: chickensoft-games/setup-godot@v2.1.1
          name: 🤖 Setup Godot
          with:
            version: 4.3.0
            use-dotnet: false
            include-templates: true
        
        - name: 🔬 Verify Setup
          run: |
              godot --version

        - name: 🛠️ Build Game
          run: |
            mkdir -v -p ./builds/${{ matrix.platform }}/${{ matrix.type }}/
            godot --headless --verbose --export-${{ matrix.type }} ${{ matrix.platform }} ./builds/${{ matrix.platform }}/${{ matrix.type }}/game
          
        - name: Upload Build Artifact
          uses: actions/upload-artifact@v4
          with:
            name: game-${{ matrix.platform }}-${{ matrix.type }}
            path: ./builds/${{ matrix.platform }}/${{ matrix.type }}

  Godot:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows]
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - name: Build
        id: build
        uses: manleydev/build-godot-action@v1.5.0
        with:
          name: example
          preset: ${{ matrix.platform }}
          debugMode: "true"
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Client - ${{ matrix.platform }}
          path: ${{ github.workspace }}/${{ steps.build.outputs.build }}