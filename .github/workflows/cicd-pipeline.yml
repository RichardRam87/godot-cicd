name: cicd-pipeline

on:
    workflow_dispatch:

permissions:
    checks: write
    contents: read

jobs:
  test:
    name: ğŸ§ªRun Tests
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4
          name: ğŸ§¾ Checkout

        - uses: MikeSchulze/gdUnit4-action@v1.1.5
          name: ğŸ”¬ execute tests
          with:
            godot-version: '4.3'
            paths: 'res://tests/'
            timeout: 5
            report-name: test_report.xml 

  build:
    needs: test
    name: Build Game
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows]
        type: [debug]
    steps:
        - uses: actions/checkout@v4
          name: ğŸ§¾ Checkout
          
        - uses: chickensoft-games/setup-godot@v1
          name: ğŸ¤– Setup Godot
          with:
            version: 4.3.0
            use-dotnet: false
        
        - name: ğŸ”¬ Verify Setup
          run: |
              godot --version
    
        - name: ğŸ› ï¸ Build Game
          run: |
            godot --headless --verbose --export-${{ matrix.type }} ${{ matrix.platform }} ./builds/${{ matrix.platform }}/${{ matrix.type }}/game
          
        - name: Upload Build Artifact
          uses: actions/upload-artifact@v4
          with:
            name: game-${{ matrix.platform }}-${{ matrix.type }}
            path: ./builds/${{ matrix.platform }}/${{ matrix.type }}