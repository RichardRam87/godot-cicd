name: cicd-pipeline

on:
    workflow_dispatch:

permissions:
    checks: write
    contents: read

jobs:
  test:
    name: üß™Run Tests
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4
          name: üßæ Checkout

        - uses: MikeSchulze/gdUnit4-action@v1.1.5
          name: üî¨ Execute Tests
          with:
            godot-version: '4.3'
            paths: 'res://tests/'
            timeout: 5
            report-name: test_report.xml 

  build:
    # needs: test - commented for now for faster test iteration
    name: üõ†Ô∏è git Build Game
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows]
        type: [debug]
    steps:
        - uses: actions/checkout@v4
          name: üßæ Checkout
          
        - uses: chickensoft-games/setup-godot@v2.1.1
          name: ü§ñ Setup Godot
          with:
            version: 4.3.0
            use-dotnet: false
            include-templates: true
        
        - name: üî¨ Verify Setup
          run: |
              godot --version
    
        - name: üì• Install rcedit
          run: |
            wget https://github.com/electron/rcedit/releases/download/v1.1.1/rcedit-x64.exe
            mkdir -p ~/.local/share/godot/editor
            mv rcedit-x64.exe ~/.local/share/godot/editor/rcedit.exe

        - name: Update export preset
          run: |
            if [ -f "export_presets.cfg" ]; then
              echo 'application/modify_resources=true' >> export_presets.cfg
              echo 'application/rcedit="~/.local/share/godot/editor/rcedit.exe"' >> export_presets.cfg
            fi

        - name: üõ†Ô∏è Build Game
          run: |
            mkdir -v -p ./builds/${{ matrix.platform }}/${{ matrix.type }}/
            godot --headless --verbose --export-${{ matrix.type }} ${{ matrix.platform }} ./builds/${{ matrix.platform }}/${{ matrix.type }}/game
          
        - name: Upload Build Artifact
          uses: actions/upload-artifact@v4
          with:
            name: game-${{ matrix.platform }}-${{ matrix.type }}
            path: ./builds/${{ matrix.platform }}/${{ matrix.type }}